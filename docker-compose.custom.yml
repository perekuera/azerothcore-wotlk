# docker-compose.yml for AzerothCore.
#
# Start the server with `docker compose up -d --build`
#
# Don't make changes this file! make a `docker-compose.override.yml` and make your
# changes there instead.

services:
  ac-database:
    container_name: ac-database
    image: mysql:8.4
    networks:
      - ac-network
    ports:
      - ${DOCKER_DB_EXTERNAL_PORT:-3306}:3306
    environment:
      - MYSQL_ROOT_PASSWORD=${DOCKER_DB_ROOT_PASSWORD:-password}
    volumes:
      - type: volume
        source: ac-database
        target: /var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: '/usr/bin/mysql --user=root --password=$$MYSQL_ROOT_PASSWORD --execute "SHOW DATABASES;"'
      interval: 5s
      timeout: 10s
      retries: 40

  ac-db-import:
    container_name: ac-db-import
    image: acore/ac-wotlk-db-import:${DOCKER_IMAGE_TAG:-master}
    networks:
      - ac-network
    build:
      context: .
      target: db-import
      dockerfile: apps/docker/Dockerfile
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
    environment:
      AC_DATA_DIR: "/azerothcore/env/dist/data"
      AC_LOGS_DIR: "/azerothcore/env/dist/logs"
      AC_LOGIN_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_auth"
      AC_WORLD_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_world"
      AC_CHARACTER_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_characters"
    volumes:
      - ${DOCKER_VOL_ETC:-./env/dist/etc}:/azerothcore/env/dist/etc
      # [osxfs optimization]: https://stackoverflow.com/a/63437557/1964544
      - ${DOCKER_VOL_LOGS:-./env/dist/logs}:/azerothcore/env/dist/logs:delegated
    depends_on:
      ac-database:
        condition: service_healthy

  ac-worldserver:
    container_name: ac-worldserver
    image: acore/ac-wotlk-worldserver:${DOCKER_IMAGE_TAG:-master}
    build:
      context: .
      target: worldserver
      dockerfile: apps/docker/Dockerfile
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
    networks:
      - ac-network
    stdin_open: true
    tty: true
    restart: unless-stopped
    env_file: ${DOCKER_AC_ENV_FILE:-conf/dist/env.ac}
    environment:
      AC_DATA_DIR: "/azerothcore/env/dist/data"
      AC_LOGS_DIR: "/azerothcore/env/dist/logs"
      AC_LOGIN_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_auth"
      AC_WORLD_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_world"
      AC_CHARACTER_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_characters"
      ##############
      # My configs #
      ##############
      ### REMOTE ACCESS ###
      AC_RA_ENABLE: "1"
      AC_RA_IP: "0.0.0.0"
      AC_RA_PORT: "3443"
      AC_SOAP_ENABLED: "1"
      #AC_SOAP_IP: "127.0.0.1"
      AC_SOAP_IP: "0.0.0.0"
      AC_SOAP_PORT: "7878"
      ### SERVER ###
      AC_GAME_TYPE: "1"
      AC_REALM_ZONE: "11"
      AC_DBC_LOCALE: "6"
      AC_CLIENT_CACHE_VERSION: "0" #OJO CON ESTO
      AC_PREVENT_AFK_LOGOUT: "2"
      ### WARDEN ###
      AC_WARDEN_ENABLED: "0"
      ### GAME MASTER ###
      AC_GM_START_LEVEL: "1"
      AC_GM_ALLOW_INVITE: "1"
      AC_GM_ALLOW_FRIEND: "1"
      ### CHEAT ###
      AC_DISABLE_WATER_BREATH: "0"
      AC_ALL_FLIGHT_PATHS: "0"
      AC_INSTANT_FLIGHT_PATHS: "2"
      AC_ALWAYS_MAX_SKILL_FOR_LEVEL: "0"
      AC_ALWAYS_MAX_WEAPON_SKILL: "0"
      AC_PLAYER_START_ALL_REPUTATION: "0"
      AC_PLAYER_START_CUSTOM_SPELLS: "1"
      AC_PLAYER_START_MAPS_EXPLORED: "0"
      AC_INSTANT_LOGOUT: "0"
      ### CHARACTER DATABASE ###
      ### CHARACTER DELETE ###
      ### CHARACTER CREATION ###
      AC_CHARACTER_CREATING_MIN_LEVEL_FOR_HEROIC_CHARACTER: "0"
      AC_START_PLAYER_MONEY: "999990000"
      AC_START_HEROIC_PLAYER_MONEY: "999990000"
      AC_PLAYER_START_STRING: "Welcome To Malparits WOW Server!"
      ### CHARACTER ###
      AC_ENABLE_PLAYER_SETTINGS: "1"
      AC_MAX_PLAYER_LEVEL: "100"
      AC_MIN_DUAL_SPEC_LEVEL: "1"
      AC_RATE_MOVE_SPEED: "3"
      AC_RATE_TALENT: "2"
      AC_RATE_TALENT_PET: "1"
      AC_RATE_HEALTH: "4"
      AC_RATE_MANA: "4"
      AC_RATE_RAGE_INCOME: "4"
      AC_RATE_RAGE_LOSS: "1"
      AC_RATE_RUNIC_POWER_INCOME: "4"
      AC_RATE_RUNIC:_POWER_LOSS: "1"
      AC_RATE_FOCUS: "4"
      AC_RATE_ENERGY: "4"
      AC_RATE_LOYALTY: "4"
      AC_NO_RESET_TALENTS_COST: "1"
      ### SKILL ###
      AC_MAX_PRIMARY_TRADE_SKILL: "11"
      AC_SKILL_CHANCE_PROSPECTING: "2"
      AC_SKILL_CHANCE_MILLING: "2"
      AC_RATE_SKILL_DISCOVERY: "2"
      ### STATS ###
      ### REPUTATION ###
      AC_RATE_REPUTATION_GAIN: "2"
      AC_RATE_REPUTATION_LOW_LEVEL_KILL: "2"
      AC_RATE_REPUTATION_LOW_LEVEL_QUEST: "2"
      ### EXPERIENCE ###
      ### CURRENCY ###
      ### DURABILITY ###
      ### DEATH  ###
      AC_DEATH_SICKNESS_LEVEL: "81"
      ### PET ###
      ### ITEM DELETE ###
      ### ITEM ###
      AC_DBC_ENFORCE_ITEM_ATTRIBUTES: "1"
      AC_RATE_DROP_ITEM_UNCOMON: "2"
      AC_RATE_DROP_ITEM_RARE: "2"
      AC_RATE_DROP_ITEM_EPIC: "2"
      AC_RATE_DROP_ITEM_LEGENDARY: "2"
      AC_RATE_DROP_ITEM_ARTIFACT: "2"
      AC_RATE_DROP_ITEM_REFERENCED: "2"
      AC_RATE_DROP_MONEY: "2"
      AC_RATE_DROP_ITEM_REFERENCED_AMOUNT: "2"
      AC_RATE_DROP_ITEM_GROUP_AMOUNT: "2"
      ### QUEST ###
      AC_QUESTS_LOW_LEVEL_HIDE_DIFF: "-1"
      AC_QUESTS_HIGH_LEVEL_HIDE_DIFF: "7"
      AC_QUESTS_IGNORE_RAID: "1"
      ### CREATURE ###
      ### VENDOR ###
      ### GROUP ###
      AC_GROUP_RAID_LEVEL_RESTRICTION: "10"
      ### INSTANCE ###
      AC_INSTANCE_GM_SUMMON_PLAYER: "1"
      AC_INSTANCE_IGNORE_LEVEL: "1"
      AC_INSTANCE_IGNORE_RAID: "1"
      AC_ACCOUNT_INSTANCES_PER_HOUR: "10"
      AC_INSTANCE_SHARED_NORMAL_HEROIC_ID: "1"
      ### DUNGEON AND BATTLEGROUPD FINDER ###
      AC_JOIN_BG_AND_LFG_ENABLE: "1"
      ### CHARTER ###
      ### GUILD ###
      AC_MIN_PETITION_SIGNS: "0"
      AC_GUILD_ALLOW_MULTIPLE_GUILD_MASTER: "1"
      AC_GUILD_BANK_INITIAL_TABS: "6"
      ### FFAPVP ###
    ports:
      - ${DOCKER_WORLD_EXTERNAL_PORT:-8085}:8085
      - ${DOCKER_SOAP_EXTERNAL_PORT:-7878}:7878
      - 3443:3443
    volumes:
      - ${DOCKER_VOL_ETC:-./env/dist/etc}:/azerothcore/env/dist/etc
      # [osxfs optimization]: https://stackoverflow.com/a/63437557/1964544
      - ${DOCKER_VOL_LOGS:-./env/dist/logs}:/azerothcore/env/dist/logs:delegated
      # client data
      - ${DOCKER_VOL_DATA:-ac-client-data}:/azerothcore/env/dist/data/:ro
    depends_on:
      ac-database:
        condition: service_healthy
      ac-db-import:
        condition: service_completed_successfully
      ac-client-data-init:
        condition: service_completed_successfully

  ac-authserver:
    container_name: ac-authserver
    image: acore/ac-wotlk-authserver:${DOCKER_IMAGE_TAG:-master}
    build:
      context: .
      target: authserver
      dockerfile: apps/docker/Dockerfile
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
    networks:
      - ac-network
    tty: true
    restart: unless-stopped
    env_file: ${DOCKER_AC_ENV_FILE:-conf/dist/env.ac}
    environment:
      AC_LOGS_DIR: "/azerothcore/env/dist/logs"
      AC_TEMP_DIR: "/azerothcore/env/dist/temp"
      AC_LOGIN_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_auth"
    volumes:
      - ${DOCKER_VOL_ETC:-./env/dist/etc}:/azerothcore/env/dist/etc
      # [osxfs optimization]: https://stackoverflow.com/a/63437557/1964544
      - ${DOCKER_VOL_LOGS:-./env/dist/logs}:/azerothcore/env/dist/logs:delegated
    ports:
      - ${DOCKER_AUTH_EXTERNAL_PORT:-3724}:3724
    depends_on:
      ac-database:
        condition: service_healthy
      ac-db-import:
        condition: service_completed_successfully

  ac-client-data-init:
    container_name: ac-client-data-init
    image: acore/ac-wotlk-client-data:${DOCKER_IMAGE_TAG:-master}
    user: ${DOCKER_USER:-root}
    build:
      context: .
      target: client-data
      dockerfile: apps/docker/Dockerfile
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
    volumes:
      - ${DOCKER_VOL_CLIENT_DATA:-ac-client-data}:/azerothcore/env/dist/data

  # used for extracting maps from files shipped with game client
  # Most of the time this shouldn't be needed
  ac-tools:
    container_name: ac-tools
    image: acore/ac-wotlk-tools:${DOCKER_IMAGE_TAG:-master}
    user: ${DOCKER_USER:-root}
    build:
      context: .
      target: tools
      dockerfile: apps/docker/Dockerfile
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
    working_dir: /azerothcore/env/client/
    volumes:
      # this is not the directory of the extracted data! It's the client folder used by the extractors
      - ${DOCKER_AC_CLIENT_FOLDER:-./var/client}:/azerothcore/env/dist/bin/Data
    # Activate with `docker compose --profile tools ...`
    profiles: [tools]

  # Dev server with the ./azerothcore folder binded from the host
  # Please use Linux, WSL2 or any ext-compatible filesystem
  # to avoid performance issues
  #
  # This is primarily intended for use with the "devcontainer" project
  #
  # This is provided primarily for development, though it doesn't receive
  # first-class support
  ac-dev-server:
    tty: true
    image: acore/ac-wotlk-dev-server:${DOCKER_IMAGE_TAG:-master}
    user: ${DOCKER_USER:-root}
    build:
      context: .
      dockerfile: ./apps/docker/Dockerfile.dev-server
      args:
        USER_ID: ${DOCKER_USER_ID:-1000}
        GROUP_ID: ${DOCKER_GROUP_ID:-1000}
        DOCKER_USER: ${DOCKER_USER:-acore}
      target: dev
    env_file: ${DOCKER_AC_ENV_FILE:-conf/dist/env.ac}
    environment:
      AC_DATA_DIR: "/azerothcore/env/dist/data"
      AC_LOGS_DIR: "/azerothcore/env/dist/logs"
      AC_LOGIN_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_auth"
      AC_WORLD_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_world"
      AC_CHARACTER_DATABASE_INFO: "ac-database;3306;root;${DOCKER_DB_ROOT_PASSWORD:-password};acore_characters"
    ports:
      - ${DOCKER_AUTH_EXTERNAL_PORT:-3724}:3724
      - ${DOCKER_WORLD_EXTERNAL_PORT:-8085}:8085
      - ${DOCKER_SOAP_EXTERNAL_PORT:-7878}:7878
    volumes:
      - ${DOCKER_VOL_ROOT:-.}:/azerothcore:cached
      # [osxfs optimization]: https://stackoverflow.com/a/63437557/1964544
      - ac-build-dev:/azerothcore/var/build
      - ac-ccache-dev:/azerothcore/var/ccache
      # this is not the directory of the extracted data! It's the client folder used by the extractors
      - ${DOCKER_AC_CLIENT_FOLDER:-./var/client}:/azerothcore/env/dist/bin/Data
    # Activate with `docker compose --profile dev ...`
    profiles: [dev]
    depends_on:
      ac-database:
        condition: service_healthy

volumes:
  ac-database:
  ac-client-data:
  # Used for dev server
  ac-build-dev:
  ac-ccache-dev:

networks:
  ac-network:
